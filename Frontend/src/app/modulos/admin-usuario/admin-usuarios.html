<div class="page">
  <div class="wrap">

    <div class="hero">
      <div class="hero-left">
        <h1>Control de Usuarios</h1>
        <p>Administración de usuarios del sistema (roles, estado y datos generales)</p>
      </div>
      <div class="hero-right">
        <a class="back-link" (click)="volver()">Volver</a>
      </div>
    </div>

    <!-- ================== CARD USUARIOS ================== -->
    <div class="card">

      <div class="section-title">
        <h2>Usuarios del sistema</h2>
        <p>Gestión: crear, editar, asignar roles y activar/desactivar cuentas</p>
      </div>

      <div class="toolbar">
        <button class="btn btn-success" (click)="abrirNuevo()">＋ Nuevo usuario</button>
        <button class="btn btn-secondary" (click)="recargar()">↻ Recargar</button>

        <input
          type="text"
          [(ngModel)]="filtro"
          placeholder="Buscar (usuario, nombre, rol, estado...)" />
      </div>

      <table class="table">
        <thead>
        <tr>
          <th>ID</th>
          <th>Usuario</th>
          <th>Nombres</th>
          <th>Apellidos</th>
          <th>Rol</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
        </thead>

        <tbody>
        <tr *ngFor="let u of usuariosFiltrados">
          <td>{{ u.idUsuario }}</td>
          <td>{{ u.username }}</td>
          <td>{{ u.nombres }}</td>
          <td>{{ u.apellidos }}</td>
          <td><span class="badge badge-info">{{ u.rol }}</span></td>

          <td>
              <span class="badge" [ngClass]="u.activo ? 'badge-success' : 'badge-pending'">
                {{ u.activo ? 'ACTIVO' : 'INACTIVO' }}
              </span>
          </td>

          <td>
            <button class="btn btn-outline" (click)="abrirEditar(u)">✏️</button>
            <button
              class="btn"
              [ngClass]="u.activo ? 'btn-warning' : 'btn-primary'"
              (click)="toggleActivo(u)">
              {{ u.activo ? 'Desactivar' : 'Activar' }}
            </button>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <!-- ================== CARD ROLES ================== -->
    <div class="card role-card">

      <div class="section-title">
        <h2>Gestión de roles</h2>
        <p>Crear roles y asignar permisos</p>
      </div>

      <div class="role-form">
        <input
          type="text"
          placeholder="Nombre del rol"
          [(ngModel)]="rolForm.nombreRol" />

        <label>
          <input type="checkbox" [(ngModel)]="rolForm.activo" />
          Activo
        </label>

        <h4>Permisos</h4>
        <div *ngFor="let permiso of permisos">
          <label>
            <input
              type="checkbox"
              [ngModel]="permisoSeleccionado(permiso.idPermiso)"
              (ngModelChange)="togglePermiso(permiso.idPermiso, $event)" />

            {{ permiso.codigo }}
          </label>
        </div>

        <button class="btn btn-success" (click)="guardarRol()">
          {{ rolModoEdicion ? 'Actualizar' : 'Crear' }} Rol
        </button>
      </div>

      <table class="table">
        <tr *ngFor="let rol of rolesSistema">
          <td>{{ rol.nombreRol }}</td>
          <td>
            <span *ngFor="let p of rol.permisos" class="badge badge-info">
              {{ p }}
            </span>
          </td>
          <td>
            <button (click)="editarRol(rol)">✏️</button>
            <button (click)="cambiarEstadoRol(rol)">
              {{ rol.activo ? 'Desactivar' : 'Activar' }}
            </button>
          </td>
        </tr>
      </table>
    </div>

  </div>
</div>

<div class="page">
  <div class="wrap">

    <div class="hero">
      <div class="hero-left">
        <h1>Control de Usuarios</h1>
        <p>Administraci√≥n de usuarios del sistema (roles, estado y datos generales)</p>
      </div>

      <div class="hero-right">
        <a class="back-link" href="javascript:void(0)" (click)="volver()">Volver</a>
      </div>
    </div>

    <div class="card">

      <div class="section-title">
        <h2>Usuarios del sistema</h2>
        <p>Gesti√≥n: crear, editar, asignar roles y activar/desactivar cuentas</p>
      </div>

      <div class="toolbar">
        <div class="toolbar-left">
          <button class="btn btn-success" type="button" (click)="abrirNuevo()">
            <span class="icon">Ôºã</span>
            Nuevo usuario
          </button>

          <button class="btn btn-secondary" type="button" (click)="recargar()">
            <span class="icon">‚Üª</span>
            Recargar
          </button>
        </div>

        <div class="toolbar-right">
          <div class="search">
            <span class="search-icon">üîé</span>
            <input type="text" [(ngModel)]="filtro" placeholder="Buscar (usuario, nombre, rol, estado...)" />
          </div>
        </div>
      </div>

      <!-- mensajes -->
      <div *ngIf="cargando" style="margin: 0.75rem 0; font-weight: 800;">Cargando...</div>
      <div *ngIf="errorMsg" style="margin: 0.75rem 0; color: #b91c1c; font-weight: 800;">{{ errorMsg }}</div>

      <div class="table-card">
        <table class="table">
          <thead>
          <tr>
            <th style="width: 80px;">ID</th>
            <th>Usuario</th>
            <th>Nombres</th>
            <th>Apellidos</th>
            <th style="width: 160px;">Rol</th>
            <th style="width: 160px;">Estado</th>
            <th style="width: 230px;">Acciones</th>
          </tr>
          </thead>

          <tbody>
          <tr *ngFor="let u of usuariosFiltrados">
            <td>{{ u.idUsuario }}</td>
            <td class="mono">{{ u.username }}</td>
            <td>{{ u.nombres }}</td>
            <td>{{ u.apellidos }}</td>

            <td>
              <span class="badge badge-info">{{ u.rol }}</span>
            </td>

            <td>
                <span class="badge" [ngClass]="u.activo ? 'badge-success' : 'badge-pending'">
                  {{ badgeEstado(u) }}
                </span>
            </td>

            <td class="actions">
              <button class="btn btn-outline" type="button" (click)="abrirEditar(u)">‚úèÔ∏è Editar</button>

              <button
                class="btn"
                [ngClass]="u.activo ? 'btn-warning' : 'btn-primary'"
                type="button"
                (click)="toggleActivo(u)">
                {{ u.activo ? 'Desactivar' : 'Activar' }}
              </button>
            </td>
          </tr>

          <tr *ngIf="!cargando && usuariosFiltrados.length === 0">
            <td colspan="7" style="padding: 1rem; color: #6b7280; font-weight: 800;">
              No hay usuarios para mostrar.
            </td>
          </tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>

  <!-- MODAL -->
  <div class="modal-backdrop" *ngIf="modalAbierto" (click)="cerrarModal()"></div>

  <div class="modal" *ngIf="modalAbierto">
    <div class="modal-card">
      <div class="modal-header">
        <h3>{{ modoEdicion ? 'Editar usuario' : 'Nuevo usuario' }}</h3>
        <button class="btn btn-secondary" type="button" (click)="cerrarModal()">‚úï</button>
      </div>

      <div class="modal-body" *ngIf="!modoEdicion">
        <div class="grid">
          <label>
            C√©dula *
            <input [(ngModel)]="formCreate.cedula" />
          </label>

          <label>
            Correo institucional *
            <input [(ngModel)]="formCreate.correoInstitucional" placeholder="algo@uteq.edu.ec" />
          </label>

          <label>
            Username *
            <input [(ngModel)]="formCreate.username" />
          </label>

          <label>
            Password *
            <input [(ngModel)]="formCreate.password" type="password" />
          </label>

          <label>
            Nombres *
            <input [(ngModel)]="formCreate.nombres" />
          </label>

          <label>
            Apellidos *
            <input [(ngModel)]="formCreate.apellidos" />
          </label>

          <label>
            Rol *
            <select [(ngModel)]="formCreate.rol">
              <option *ngFor="let r of roles" [value]="r">{{ r }}</option>
            </select>
          </label>

          <label class="check">
            <input type="checkbox" [(ngModel)]="formCreate.activo" />
            Activo
          </label>
        </div>
      </div>

      <div class="modal-body" *ngIf="modoEdicion">
        <div class="grid">
          <label>
            Nombres
            <input [(ngModel)]="formUpdate.nombres" />
          </label>

          <label>
            Apellidos
            <input [(ngModel)]="formUpdate.apellidos" />
          </label>

          <label>
            Rol
            <select [(ngModel)]="formUpdate.rol">
              <option *ngFor="let r of roles" [value]="r">{{ r }}</option>
            </select>
          </label>

          <label class="check">
            <input type="checkbox" [(ngModel)]="formUpdate.activo" />
            Activo
          </label>

          <label>
            Password (opcional)
            <input [(ngModel)]="formUpdate.password" type="password" placeholder="dejar vac√≠o para no cambiar" />
          </label>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" (click)="cerrarModal()">Cancelar</button>
        <button class="btn btn-success" type="button" (click)="guardar()">Guardar</button>
      </div>
    </div>
  </div>
</div>
